# Adding self-managed Kubernetes clusters to HCP Consul

## Prerequisites

1. Create a GCP project

1. Enable the following APIs for the project:
   - Service Usage API
   - Kubernetes Engine API
   - IAM Service Account Credentials API

1. Create a service account for Terraform with the following
   roles:
   - Editor
   - Kubernetes Engine Admin

1. Create an HCP account

1. Download [consul-k8s](https://github.com/hashicorp/consul-k8s/tree/main#cli).

## Create GKE cluster

1. Go to `gcp/cluster`.

1. Define the variables in `variables.tf`.

1. Set GCP credentials as environment variables with the service
   account credentials.
   - `GOOGLE_CREDENTIALS`

1. Run Terraform to create the cluster.

## Deploy HCP Consul to GKE cluster

> Note: We cannot use the Consul Helm chart to link a self-managed
> cluster to HCP because you need to generate a series of bootstrap
> tokens using the HCP API. This ensures that HCP Consul has proper
> access to the cluster with least-privilege ACL policies.

1. Go to the "Consul" tab in your HCP project.

1. Select "Self-Managed Consul".

1. Set up cluster details.

1. The next view should have a CLI command for `consul-k8s`.
   Copy this CLI command and save it somewhere.

1. Set your `kubectl` locally to point to your GKE cluster.

   ```shell
   gcloud container clusters get-credentials service-mesh-at-scale --region us-central1-a
   ```

1. Set the following environment variables generated by the CLI command you copied
   from HCP Consul.
   ```shell
   export HCP_CLIENT_ID=${CLIENT_ID}
   export HCP_CLIENT_SECRET=${CLIENT_SECRET}
   export HCP_RESOURCE_ID=${RESOURCE_ID}
   ```

1. Run the consul deploy script.
   ```shell
   bash consul.sh
   ```

1. Navigate to the HCP Consul dashboard to examine your self-managed cluster.
   If you want to access the Consul cluster, you can retrieve the address
   and token from `consul.json`.